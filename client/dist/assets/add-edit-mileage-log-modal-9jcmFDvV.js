import{j as e,B as K,E as Q,r as S,F as J,G as z}from"./ui-components-HGHSQozB.js";import{u as W,z as u}from"./form-libs-rs9Sv7dn.js";import{F as Y,b as w,c as I,a as C,d as U,f as O,t as Z,I as M}from"./input-CRt7uJVD.js";import{b as T,u as L,B as j}from"./button-DIi07IbY.js";import{D as ee,f as te}from"./date-libs-B3w1lJ5d.js";import{c as F,d as y,a as R,q as re}from"./index-DigxZtx1.js";import{D as ae,a as se,b as oe,c as ne,d as le,e as de,f as ie}from"./dialog-C5mG64l5.js";import{T as ce}from"./textarea-_oBjrA3M.js";import{a as me}from"./schema-D93SEq94.js";import{L as $}from"./loader-circle-DRr2b1ki.js";import{C as ue}from"./cloud-upload-Bzd53IsB.js";import"./data-fetching-CsvQ4U53.js";import"./react-vendor-BDjHMAeo.js";import"./auth-DQqL1F4Z.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=F("Calendar",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=F("ChevronLeft",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=F("ChevronRight",[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=F("CircleX",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]);function q({className:s,classNames:g,showOutsideDays:a=!0,...v}){return e.jsx(ee,{showOutsideDays:a,className:y("p-3",s),classNames:{months:"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",month:"space-y-4",caption:"flex justify-center pt-1 relative items-center",caption_label:"text-sm font-medium",nav:"space-x-1 flex items-center",nav_button:y(T({variant:"outline"}),"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100"),nav_button_previous:"absolute left-1",nav_button_next:"absolute right-1",table:"w-full border-collapse space-y-1",head_row:"flex",head_cell:"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]",row:"flex w-full mt-2",cell:"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",day:y(T({variant:"ghost"}),"h-9 w-9 p-0 font-normal aria-selected:opacity-100"),day_range_end:"day-range-end",day_selected:"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",day_today:"bg-accent text-accent-foreground",day_outside:"day-outside text-muted-foreground opacity-50 aria-selected:bg-accent/50 aria-selected:text-muted-foreground aria-selected:opacity-30",day_disabled:"text-muted-foreground opacity-50",day_range_middle:"aria-selected:bg-accent aria-selected:text-accent-foreground",day_hidden:"invisible",...g},components:{IconLeft:({...c})=>e.jsx(he,{className:"h-4 w-4"}),IconRight:({...c})=>e.jsx(fe,{className:"h-4 w-4"})},...v})}q.displayName="Calendar";const ge=K,ve=Q,V=S.forwardRef(({className:s,align:g="center",sideOffset:a=4,...v},c)=>e.jsx(J,{children:e.jsx(z,{ref:c,align:g,sideOffset:a,className:y("z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",s),...v})}));V.displayName=z.displayName;const be=u.object({tripDate:u.date({required_error:"Trip date is required."}),startOdometer:u.preprocess(s=>s===""||s===void 0||s===null?void 0:Number(s),u.number({invalid_type_error:"Start odometer must be a number."}).positive("Start odometer must be positive").optional()),endOdometer:u.preprocess(s=>s===""||s===void 0||s===null?void 0:Number(s),u.number({invalid_type_error:"End odometer must be a number."}).positive("End odometer must be positive").optional()),purpose:u.string().optional(),tripId:u.number().int().positive().optional().nullable(),startImageUrl:u.string().url().nullable().optional(),endImageUrl:u.string().url().nullable().optional()}).refine(s=>typeof s.startOdometer=="number"&&typeof s.endOdometer=="number"?s.endOdometer>s.startOdometer:!0,{message:"End odometer reading must be greater than start odometer reading",path:["endOdometer"]}),N={file:null,url:null,loading:!1,error:null};function Pe({isOpen:s,onClose:g,mileageLog:a,tripId:v}){const{toast:c}=L(),h=!!a,[x,D]=S.useState({start:{...N},end:{...N}}),b=(t,r)=>{D(d=>({...d,[t]:{...d[t],...r}}))},n=W({resolver:Z(be)});S.useEffect(()=>{if(s){const t=(a==null?void 0:a.startImageUrl)??null,r=(a==null?void 0:a.endImageUrl)??null;n.reset({tripId:(a==null?void 0:a.tripId)??v??null,tripDate:a!=null&&a.tripDate?new Date(a.tripDate):new Date,startOdometer:a?parseFloat(a.startOdometer):void 0,endOdometer:a?parseFloat(a.endOdometer):void 0,purpose:(a==null?void 0:a.purpose)??"",startImageUrl:t,endImageUrl:r}),D({start:{...N,url:t},end:{...N,url:r}})}},[a,v,n,s]);const A=async(t,r)=>{if(!t)return;const d=r==="start"?"startOdometer":"endOdometer",m=r==="start"?"startImageUrl":"endImageUrl";b(r,{loading:!0,error:null,file:t});const p=new FormData;p.append("odometerImage",t);try{const i=await R("POST","/api/mileage-logs/upload-odometer-image",p);if(!i.ok){let l={};try{l=await i.json()}catch{}throw new Error(l.error||i.statusText||"Image upload failed")}const o=await i.json();if(o.success)b(r,{url:o.imageUrl}),n.setValue(m,o.imageUrl),o.reading!==void 0?(n.setValue(d,o.reading),c({title:"OCR Success",description:`Odometer reading set to ${o.reading}.`})):c({title:"Image Uploaded",description:"Image uploaded, but OCR couldn't extract reading."});else throw new Error(o.error||"Image upload failed")}catch(i){console.error(`Failed to upload/process ${r} odometer image:`,i);const o=i instanceof Error?i.message:"An unknown error occurred.";b(r,{error:o,url:null,file:null}),n.setValue(m,null),c({title:`Upload Failed (${r})`,description:o,variant:"destructive"})}finally{b(r,{loading:!1})}},B=(t,r)=>{var m;const d=(m=t.target.files)==null?void 0:m[0];d&&A(d,r),t.target.value=""},X=t=>{const r=t==="start"?"startImageUrl":"endImageUrl";b(t,{file:null,url:null,error:null}),n.setValue(r,null)},G=async t=>{var E,k,P;const r=h?"PUT":"POST",d=h?`/api/mileage-logs/${a==null?void 0:a.id}`:"/api/mileage-logs",m=x.start.url,p=x.end.url,o={...t,startImageUrl:m,endImageUrl:p,entryMethod:m||p?"ocr":"manual"},l=me.safeParse(o);if(!l.success){console.error("Final validation failed:",l.error.flatten()),c({title:"Validation Error",description:((E=l.error.errors[0])==null?void 0:E.message)||"Please check the form fields for errors.",variant:"destructive"});const f=(k=l.error.errors[0])==null?void 0:k.path[0];f&&typeof f=="string"&&n.control._fields[f]?n.setFocus(f):(P=l.error.errors[0])!=null&&P.path.includes("endOdometer")&&n.setFocus("endOdometer");return}try{await R(r,d,l.data),c({title:`Mileage log ${h?"updated":"added"}`,description:`Successfully ${h?"updated":"added"} the mileage log.`}),re.invalidateQueries({queryKey:["/api/mileage-logs"]}),g()}catch(f){console.error("Failed to save mileage log:",f),c({title:`Failed to ${h?"update":"add"} mileage log`,description:f instanceof Error?f.message:"An unknown error occurred.",variant:"destructive"})}},H=t=>{t||g()},_=t=>{const r=x[t],d=t==="start"?"startOdometer":"endOdometer",m=t==="start"?"startImageUrl":"endImageUrl",p=t==="start"?"Start":"End",i=t==="start"?"e.g., 12345.6":"e.g., 12400.2";return e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{control:n.control,name:d,render:({field:o})=>e.jsxs(I,{children:[e.jsxs(C,{children:[p," Odometer"]}),e.jsx(U,{children:e.jsx(M,{type:"number",step:"0.1",placeholder:i,value:o.value??"",onChange:l=>o.onChange(l.target.value===""?void 0:+l.target.value)})}),e.jsx(O,{})]})}),e.jsxs(I,{children:[e.jsxs(C,{htmlFor:`${t}OdometerImage`,className:"text-sm font-medium",children:[p," Odometer Image"]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[" ",e.jsxs(j,{type:"button",variant:"outline",size:"sm",className:"relative",disabled:r.loading,children:[r.loading?e.jsx($,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(ue,{className:"mr-2 h-4 w-4"}),"Upload ",p,e.jsx(M,{id:`${t}OdometerImage`,type:"file",accept:"image/*",className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",onChange:o=>B(o,t),disabled:r.loading})]}),r.url&&!r.loading&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("a",{href:r.url,target:"_blank",rel:"noopener noreferrer",className:"text-xs text-blue-600 hover:underline truncate max-w-[100px]",title:r.url,children:"View Image"}),e.jsx(j,{type:"button",variant:"ghost",size:"icon",className:"h-5 w-5 text-red-500 hover:bg-red-100",onClick:()=>X(t),"aria-label":`Clear ${t} image`,children:e.jsx(xe,{className:"h-4 w-4"})})]})]}),r.error&&e.jsx("p",{className:"text-sm font-medium text-destructive",children:r.error}),e.jsx(w,{control:n.control,name:m,render:({field:o})=>o.value?e.jsxs("p",{className:"text-xs text-muted-foreground mt-1 truncate",title:o.value,children:["URL: ",o.value.substring(0,30),"..."]}):null})]})]})};return e.jsx(ae,{open:s,onOpenChange:H,children:e.jsxs(se,{className:"sm:max-w-[520px]",children:[e.jsxs(oe,{children:[e.jsx(ne,{children:h?"Edit Mileage Log":"Add New Mileage Log"}),e.jsx(le,{children:h?"Update the details of your mileage log.":"Enter details or upload odometer images for automatic reading."})]}),e.jsx(Y,{...n,children:e.jsxs("form",{onSubmit:n.handleSubmit(G),className:"space-y-4 py-2 max-h-[70vh] overflow-y-auto pr-2",children:[" ",e.jsx(w,{control:n.control,name:"tripDate",render:({field:t})=>e.jsxs(I,{className:"flex flex-col",children:[e.jsx(C,{children:"Trip Date"}),e.jsxs(ge,{children:[e.jsx(ve,{asChild:!0,children:e.jsx(U,{children:e.jsxs(j,{variant:"outline",className:y("w-full pl-3 text-left font-normal",!t.value&&"text-muted-foreground"),children:[t.value?te(t.value,"PPP"):e.jsx("span",{children:"Pick a date"}),e.jsx(pe,{className:"ml-auto h-4 w-4 opacity-50"})]})})}),e.jsx(V,{className:"w-auto p-0",align:"start",children:e.jsx(q,{mode:"single",selected:t.value,onSelect:t.onChange,disabled:r=>r>new Date||r<new Date("1900-01-01"),initialFocus:!0})})]}),e.jsx(O,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[_("start"),_("end")]}),e.jsx(w,{control:n.control,name:"purpose",render:({field:t})=>e.jsxs(I,{children:[e.jsx(C,{children:"Purpose (Optional)"}),e.jsx(U,{children:e.jsx(ce,{placeholder:"e.g., Client meeting, Site visit",...t,value:t.value??""})}),e.jsx(O,{})]})}),e.jsxs(de,{className:"pt-4",children:[" ",e.jsx(ie,{asChild:!0,children:e.jsx(j,{type:"button",variant:"outline",children:"Cancel"})}),e.jsx(j,{type:"submit",disabled:n.formState.isSubmitting||x.start.loading||x.end.loading,children:n.formState.isSubmitting||x.start.loading||x.end.loading?e.jsxs(e.Fragment,{children:[e.jsx($,{className:"mr-2 h-4 w-4 animate-spin"})," Saving..."]}):h?"Update Log":"Add Log"})]})]})})]})})}export{Pe as default};
