import{r as p,j as e}from"./ui-components-HGHSQozB.js";import{c as E,u as U,a as k,s as C,q as R}from"./index-DigxZtx1.js";import{u as $}from"./data-fetching-CsvQ4U53.js";import{S as _}from"./sidebar-CmFT8L_W.js";import{u as I,B as f}from"./button-DIi07IbY.js";import{u as Y}from"./react-vendor-BDjHMAeo.js";import{A as G}from"./animated-page-XK2k_SWk.js";import{P,A as W,a as Z,R as J}from"./receipt-viewer-modal-C3RSGosi.js";import{D as X,a as ee,b as se,c as te,d as re,e as ae}from"./dialog-C5mG64l5.js";import{S as D,a as A,b as T,c as F,d as j}from"./select-z9Vzp6Nk.js";import{L as ne,I as oe}from"./input-CRt7uJVD.js";import{L as V}from"./loader-circle-DRr2b1ki.js";import{C as le,a as ie}from"./card-CClv9YG9.js";import{A as ce,a as de,b as xe,c as pe,d as me,e as he,f as ue,g as ge,h as ye}from"./alert-dialog-BTH45kxy.js";import{T as je}from"./trash-2-BesVaEJk.js";import{f as fe}from"./date-libs-B3w1lJ5d.js";import"./auth-DQqL1F4Z.js";import"./form-libs-rs9Sv7dn.js";import"./textarea-_oBjrA3M.js";import"./receipt-upload-B52gNKqR.js";import"./file-text-1oqK6nM4.js";import"./upload-glmsZqHP.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ve=E("ArrowUpDown",[["path",{d:"m21 16-4 4-4-4",key:"f6ql7i"}],["path",{d:"M17 20V4",key:"1ejh1v"}],["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=E("Eye",[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=E("FileSpreadsheet",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M8 13h2",key:"yr2amv"}],["path",{d:"M14 13h2",key:"un5t4a"}],["path",{d:"M8 17h2",key:"2yhykz"}],["path",{d:"M14 17h2",key:"10kma7"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const we=E("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ee=E("SquarePen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]]);function ke(){const{exportExpensesOpen:m,toggleExportExpenses:h}=U(),{toast:g}=I(),[y,c]=p.useState("xlsx"),[a,d]=p.useState(!1),o=async()=>{d(!0);try{const x=await k("POST","/api/export-expenses",{format:y,filters:{}});if(x.status===202){const N=await x.json();g({title:"Export Started",description:"Your expense export is being generated. You'll be notified when it's ready."}),console.log("Background Task Info:",N.task),h()}else{const N=await x.json().catch(()=>({message:"Unknown error starting export."}));throw new Error(N.message||`Failed to start export (Status: ${x.status})`)}}catch(s){g({title:"Export Error",description:s instanceof Error?s.message:"An unknown error occurred.",variant:"destructive"})}finally{d(!1)}},u=()=>{c("xlsx"),d(!1),h()};return h?e.jsx(X,{open:m,onOpenChange:s=>{s||u()},children:e.jsxs(ee,{children:[e.jsxs(se,{children:[e.jsx(te,{children:"Export Expenses"}),e.jsx(re,{children:"Select the format for your expense export. Filters can be applied on the main page."})]}),e.jsx("div",{className:"py-4 space-y-4",children:e.jsxs("div",{children:[e.jsx(ne,{htmlFor:"format-select",children:"Export Format"}),e.jsxs(D,{value:y,onValueChange:s=>c(s),children:[e.jsx(A,{id:"format-select",children:e.jsx(T,{placeholder:"Select format"})}),e.jsxs(F,{children:[e.jsx(j,{value:"xlsx",children:"Excel (.xlsx)"}),e.jsx(j,{value:"csv",children:"CSV (.csv)"})]})]})]})}),e.jsxs(ae,{children:[e.jsx(f,{variant:"outline",onClick:u,disabled:a,children:"Cancel"}),e.jsx(f,{onClick:o,disabled:a,children:a?e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"mr-2 h-4 w-4 animate-spin"})," Starting Export..."]}):"Start Export"})]})]})}):(console.warn("Export modal store not configured correctly."),null)}const Se=({searchQuery:m,setSearchQuery:h,tripFilter:g,setTripFilter:y,sortField:c,setSortField:a,trips:d})=>e.jsx(le,{className:"mb-6",children:e.jsx(ie,{className:"p-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(we,{className:"absolute left-2.5 top-2.5 h-4 w-4 text-gray-500 dark:text-gray-400"}),e.jsx(oe,{placeholder:"Search expenses...",className:"pl-8",value:m,onChange:o=>h(o.target.value)})]}),e.jsxs(D,{value:g,onValueChange:y,children:[e.jsx(A,{children:e.jsx(T,{placeholder:"Filter by trip"})}),e.jsxs(F,{children:[e.jsx(j,{value:"all",children:"All Trips"}),d==null?void 0:d.map(o=>e.jsx(j,{value:o.name,children:o.name},o.id))]})]}),e.jsxs(D,{value:c,onValueChange:a,children:[e.jsx(A,{className:"w-full",children:e.jsx(T,{placeholder:"Sort by"})}),e.jsxs(F,{children:[e.jsx(j,{value:"date",children:"Date"}),e.jsx(j,{value:"cost",children:"Amount"}),e.jsx(j,{value:"vendor",children:"Vendor"}),e.jsx(j,{value:"type",children:"Type"})]})]})]})})}),Ce=({expenses:m,sortField:h,sortDirection:g,handleSort:y,handleDelete:c,viewReceipt:a,editExpense:d})=>{const o=s=>h!==s?null:e.jsx(ve,{className:`ml-1 h-3 w-3 ${g==="asc"?"transform rotate-180":""}`}),u=(s,b,x="left")=>e.jsx("th",{className:`text-${x} py-3 px-4 font-medium text-xs uppercase text-gray-500 dark:text-gray-400 cursor-pointer`,onClick:()=>y(s),children:e.jsxs("div",{className:`flex items-center ${x==="right"?"justify-end":""}`,children:[b,o(s)]})});return e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50 dark:bg-gray-700/50 border-b dark:border-gray-700",children:[u("date","Date"),u("type","Type"),u("vendor","Vendor"),e.jsx("th",{className:"text-left py-3 px-4 font-medium text-xs uppercase text-gray-500 dark:text-gray-400",children:"Location"}),e.jsx("th",{className:"text-left py-3 px-4 font-medium text-xs uppercase text-gray-500 dark:text-gray-400",children:"Comments/Desc."}),e.jsx("th",{className:"text-left py-3 px-4 font-medium text-xs uppercase text-gray-500 dark:text-gray-400",children:"Trip"}),u("cost","Amount","right"),e.jsx("th",{className:"text-center py-3 px-4 font-medium text-xs uppercase text-gray-500 dark:text-gray-400",children:"Receipt"}),e.jsx("th",{className:"text-center py-3 px-4 font-medium text-xs uppercase text-gray-500 dark:text-gray-400",children:"Actions"})]})}),e.jsx("tbody",{children:m.length>0?m.map(s=>e.jsxs("tr",{className:"border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/30",children:[e.jsx("td",{className:"py-3 px-4",children:fe(new Date(s.date),"MMM d, yyyy")}),e.jsx("td",{className:"py-3 px-4",children:s.type}),e.jsx("td",{className:"py-3 px-4",children:s.vendor}),e.jsx("td",{className:"py-3 px-4",children:s.location}),e.jsx("td",{className:"py-3 px-4 text-sm text-gray-600 dark:text-gray-400 max-w-xs truncate",title:s.comments||"",children:s.comments||"-"}),e.jsx("td",{className:"py-3 px-4",children:e.jsx("span",{className:"px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-primary text-xs rounded-full",children:s.tripName})}),e.jsxs("td",{className:"py-3 px-4 text-right font-medium",children:["$",(typeof s.cost=="number"?s.cost:parseFloat(s.cost)).toFixed(2)]}),e.jsx("td",{className:"py-3 px-4 text-center",children:s.receiptPath?e.jsx(f,{variant:"ghost",size:"sm",className:"text-blue-500 hover:text-blue-700",onClick:()=>a(`/uploads/${s.receiptPath}`),children:e.jsx(be,{className:"h-4 w-4"})}):e.jsx("span",{className:"text-gray-400 text-sm",children:"None"})}),e.jsx("td",{className:"py-3 px-4 text-center",children:e.jsxs("div",{className:"flex justify-center space-x-2",children:[e.jsx(f,{variant:"ghost",size:"sm",className:"text-gray-500 hover:text-primary",onClick:()=>d(s),children:e.jsx(Ee,{className:"h-4 w-4"})}),e.jsxs(ce,{children:[e.jsx(de,{asChild:!0,children:e.jsx(f,{variant:"ghost",size:"sm",className:"text-gray-500 hover:text-red-500",children:e.jsx(je,{className:"h-4 w-4"})})}),e.jsxs(xe,{children:[e.jsxs(pe,{children:[e.jsx(me,{children:"Delete Expense"}),e.jsx(he,{children:"Are you sure? This action cannot be undone."})]}),e.jsxs(ue,{children:[e.jsx(ge,{children:"Cancel"}),e.jsx(ye,{className:"bg-red-500 hover:bg-red-600",onClick:()=>c(s.id),children:"Delete"})]})]})]})]})})]},s.id)):e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"py-6 text-center text-gray-500 dark:text-gray-400",children:"No expenses found."})})})]})})})};function We(){const{toggleAddExpense:m,openReceiptViewer:h,toggleEditExpense:g,toggleExportExpenses:y}=U(),{toast:c}=I(),[a,d]=p.useState("all"),[o,u]=p.useState(""),[s,b]=p.useState("date"),[x,N]=p.useState("desc");Y();const{data:S,isLoading:z}=$({queryKey:["/api/expenses"],queryFn:()=>k("GET","/api/expenses").then(t=>t.json())}),{data:B,isLoading:O}=$({queryKey:["/api/trips"],queryFn:()=>k("GET","/api/trips").then(t=>t.json())});p.useEffect(()=>{const i=new URLSearchParams(window.location.search).get("trip");i&&d(decodeURIComponent(i))},[]),p.useEffect(()=>{if(!C)return;let t=null;return(()=>{t=C.channel("expense-updates").on("postgres_changes",{event:"UPDATE",schema:"public",table:"expenses"},r=>{console.log("Expense update received:",r);const l=r.old,n=r.new,w=l==null?void 0:l.status,v=n==null?void 0:n.status;w!==v&&(console.log(`Expense ${n.id} status changed from ${w} to ${v}. Invalidating query.`),R.invalidateQueries({queryKey:["/api/expenses"]}),v==="complete"?c({title:"OCR Complete",description:`Receipt for expense ${n.id} processed.`}):v==="ocr_failed"&&c({title:"OCR Failed",description:`Processing failed for expense ${n.id}: ${n.ocrError||"Unknown error"}`,variant:"destructive"}))}).subscribe((r,l)=>{r==="SUBSCRIBED"?console.log("Subscribed to expense updates!"):(r==="CHANNEL_ERROR"||r==="TIMED_OUT")&&console.error("Expense subscription error:",r,l==null?void 0:l.message)})})(),()=>{t&&C.removeChannel(t).then(()=>console.log("Unsubscribed from expense updates.")).catch(r=>console.error("Error unsubscribing from expense updates:",r.message))}},[c]);const H=async t=>{try{await k("DELETE",`/api/expenses/${t}`),R.invalidateQueries({queryKey:["/api/expenses"]}),c({title:"Expense deleted"})}catch(i){c({title:"Delete failed",description:i instanceof Error?i.message:"Unknown error",variant:"destructive"})}},Q=p.useCallback(()=>S?S.filter(t=>{var n,w,v,q;const i=a==="all"||t.tripName===a,r=o.toLowerCase(),l=o===""||((n=t.vendor)==null?void 0:n.toLowerCase().includes(r))||((w=t.location)==null?void 0:w.toLowerCase().includes(r))||((v=t.type)==null?void 0:v.toLowerCase().includes(r))||((q=t.comments)==null?void 0:q.toLowerCase().includes(r));return i&&l}).sort((t,i)=>{let r=0;const l=t[s],n=i[s];return s==="date"?r=new Date(t.date).getTime()-new Date(i.date).getTime():s==="cost"?r=(typeof l=="number"?l:parseFloat(l))-(typeof n=="number"?n:parseFloat(n)):typeof l=="string"&&typeof n=="string"&&(r=l.localeCompare(n)),x==="asc"?r:-r}):[],[S,a,o,s,x]),K=p.useCallback(t=>{N(i=>s===t&&i==="asc"?"desc":"asc"),b(t)},[s]),L=z||O,M=Q();return e.jsxs("div",{className:"flex flex-col md:flex-row h-screen",children:[e.jsx(_,{}),e.jsxs(G,{className:"flex-1 overflow-y-auto p-4 md:p-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row items-start md:items-center justify-between mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold mb-2 md:mb-0",children:"Expenses"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(f,{variant:"outline",onClick:y,children:[e.jsx(Ne,{className:"h-4 w-4 mr-2"})," Export Expenses"]}),e.jsxs(f,{className:"bg-primary text-primary-foreground hover:bg-primary/90",onClick:()=>m(a!=="all"?a:void 0),children:[e.jsx(P,{className:"h-4 w-4 mr-2"})," Add Expense"]})]})]}),e.jsx(Se,{searchQuery:o,setSearchQuery:u,tripFilter:a,setTripFilter:d,sortField:s,setSortField:b,trips:B}),L?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(V,{className:"h-8 w-8 animate-spin text-primary"})}):e.jsx(Ce,{expenses:M,sortField:s,sortDirection:x,handleSort:K,handleDelete:H,viewReceipt:h,editExpense:g}),!L&&M.length===0&&e.jsx("div",{className:"text-center py-10 text-gray-500 dark:text-gray-400",children:o||a!=="all"?"No expenses match your search criteria.":e.jsxs("div",{className:"flex flex-col items-center justify-center",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-12 w-12 text-gray-400 mb-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 10c0 5-3.5 8.5-7 11.5-3.5-3-7-6.5-7-11.5a7 7 0 1114 0z"})}),e.jsx("p",{className:"mb-4",children:"No expenses have been added yet."}),e.jsxs(f,{className:"bg-primary text-primary-foreground hover:bg-primary/90",onClick:()=>m(a!=="all"?a:void 0),children:[e.jsx(P,{className:"h-4 w-4 mr-2"})," Add Your First Expense"]})]})})]}),e.jsx(W,{}),e.jsx(Z,{}),e.jsx(J,{}),e.jsx(ke,{})]})}export{We as default};
