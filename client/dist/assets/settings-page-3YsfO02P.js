import{r as d,j as e,i as _,L as z,k as G,l as $}from"./ui-components-HGHSQozB.js";import{u as ee,z as j}from"./form-libs-rs9Sv7dn.js";import{F as se,b as k,c as R,a as O,d as S,e as T,f as A,I as te,t as re}from"./input-CRt7uJVD.js";import{S as ae}from"./sidebar-CmFT8L_W.js";import{c as ie,d as I,b as B,a as V}from"./index-DigxZtx1.js";import{u as M,B as h}from"./button-DIi07IbY.js";import{a as ne}from"./data-fetching-CsvQ4U53.js";import{L as y}from"./loader-circle-DRr2b1ki.js";import{C as Q,b as H,c as J,d as W,a as X,e as ce}from"./card-CClv9YG9.js";import{S as D,a as L,b as q,c as U,d as f}from"./select-z9Vzp6Nk.js";import{A as oe}from"./animated-page-XK2k_SWk.js";import{U as le}from"./upload-glmsZqHP.js";import{C as de}from"./circle-alert-CzkXali5.js";import"./react-vendor-BDjHMAeo.js";import"./auth-DQqL1F4Z.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const me=ie("CircleCheckBig",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]);function pe(){const[s,t]=d.useState(!1),{toast:r}=M(),c=ne(),i=async()=>{t(!0);try{const a=await fetch("/api/background-processor/process-next",{method:"POST",headers:{"Content-Type":"application/json"}});if(!a.ok){const m=await a.text();throw new Error(`Failed to process task: ${m}`)}const l=await a.json();l.message==="No pending tasks found"?r({title:"No pending tasks",description:"There are no pending OCR tasks to process."}):l.error?r({title:"OCR processing failed",description:l.error,variant:"destructive"}):(r({title:"OCR processing complete",description:`Successfully processed receipt for expense ${l.expenseId}`}),c.invalidateQueries({queryKey:["/api/expenses"]}),c.invalidateQueries({queryKey:["/api/background-tasks"]}))}catch(a){r({title:"Error processing OCR task",description:a instanceof Error?a.message:"An unknown error occurred",variant:"destructive"})}finally{t(!1)}};return e.jsxs("div",{className:"bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-100 dark:border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Receipt OCR Processing"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"Process receipts with OCR (Optical Character Recognition) to automatically extract information. This will analyze any pending receipts and update the corresponding expenses with the extracted data."}),e.jsx(h,{onClick:i,disabled:s,className:"w-full md:w-auto",children:s?e.jsxs(e.Fragment,{children:[e.jsx(y,{className:"mr-2 h-4 w-4 animate-spin"}),"Processing..."]}):"Process Next Receipt"})]})}const xe=_,Y=d.forwardRef(({className:s,...t},r)=>e.jsx(z,{ref:r,className:I("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",s),...t}));Y.displayName=z.displayName;const P=d.forwardRef(({className:s,...t},r)=>e.jsx(G,{ref:r,className:I("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",s),...t}));P.displayName=G.displayName;const F=d.forwardRef(({className:s,...t},r)=>e.jsx($,{ref:r,className:I("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",s),...t}));F.displayName=$.displayName;const he=j.object({ocrMethod:j.string(),ocrApiKey:j.string().optional(),ocrTemplate:j.enum(["travel"])}),ue=()=>{const{theme:s,toggleTheme:t}=B();return e.jsxs(Q,{children:[e.jsxs(H,{children:[e.jsx(J,{children:"Appearance"}),e.jsx(W,{children:"Customize how the application looks."})]}),e.jsx(X,{className:"space-y-4",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-md font-medium",children:"Dark Mode"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Toggle theme."})]}),e.jsx(h,{variant:"outline",onClick:t,children:s==="dark"?"Switch to Light":"Switch to Dark"})]})})]})},ge=({ocrForm:s,onOcrSubmit:t,testOcrSettings:r,isSubmitting:c})=>e.jsx(se,{...s,children:e.jsxs("form",{onSubmit:s.handleSubmit(t),className:"space-y-6",children:[e.jsx(k,{control:s.control,name:"ocrMethod",render:({field:i})=>e.jsxs(R,{children:[e.jsx(O,{children:"OCR Method"}),e.jsxs(D,{value:i.value,onValueChange:a=>{i.onChange(a),a==="tesseract"&&s.setValue("ocrApiKey","")},children:[e.jsx(S,{children:e.jsx(L,{children:e.jsx(q,{placeholder:"Select OCR method"})})}),e.jsxs(U,{children:[e.jsx(f,{value:"gemini",children:"Google Gemini (Recommended)"}),e.jsx(f,{value:"openai",children:"OpenAI Vision"}),e.jsx(f,{value:"claude",children:"Anthropic Claude"}),e.jsx(f,{value:"openrouter",children:"OpenRouter"})]})]}),e.jsx(T,{children:"Select the OCR method for data extraction."}),e.jsx(A,{})]})}),e.jsx(k,{control:s.control,name:"ocrApiKey",render:({field:i})=>e.jsxs(R,{children:[e.jsx(O,{children:"API Key"}),e.jsx(S,{children:e.jsx(te,{type:"password",placeholder:"Enter API key",...i,value:i.value||""})}),e.jsx(T,{children:`Enter your ${s.watch("ocrMethod")} API key.`}),e.jsx(A,{})]})}),e.jsx(k,{control:s.control,name:"ocrTemplate",render:({field:i})=>e.jsxs(R,{children:[e.jsx(O,{children:"OCR Data Extraction Template"}),e.jsxs(D,{value:i.value,onValueChange:a=>i.onChange(a),children:[e.jsx(S,{children:e.jsx(L,{children:e.jsx(q,{placeholder:"Select template"})})}),e.jsx(U,{children:e.jsx(f,{value:"travel",children:"Travel Expenses"})})]}),e.jsx(T,{children:"Choose a template to guide AI extraction."}),e.jsx(A,{})]})}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(h,{type:"submit",disabled:c,children:c?e.jsxs(e.Fragment,{children:[e.jsx(y,{className:"mr-2 h-4 w-4 animate-spin"})," Saving..."]}):"Save OCR Settings"}),e.jsx(h,{type:"button",variant:"outline",onClick:r,disabled:c,children:c?e.jsxs(e.Fragment,{children:[e.jsx(y,{className:"mr-2 h-4 w-4 animate-spin"})," Testing..."]}):"Test OCR"})]})]})}),fe=({ocrForm:s,isSubmitting:t})=>{const{toast:r}=M(),c=d.useRef(null),[i,a]=d.useState("none"),[l,m]=d.useState(""),[x,p]=d.useState({}),g=()=>{var n;return(n=c.current)==null?void 0:n.click()},b=async n=>{var K,E;const o=(K=n.target.files)==null?void 0:K[0];if(!o)return;const v=s.getValues();if(!((E=v.ocrApiKey)!=null&&E.trim())){r({title:"API Key Required",description:`Enter ${v.ocrMethod} API key and save.`,variant:"destructive"});return}a("loading"),m("Processing receipt..."),p({});const N=new FormData;N.append("receipt",o),N.append("template",v.ocrTemplate);try{const u=await(await fetch("/api/ocr/process",{method:"POST",body:N})).json();if(u.success){p(u.data||{});const Z=u.data&&Object.values(u.data).some(w=>w&&(typeof w=="string"?w.trim()!=="":!0));a("success"),m(u.pdfMessage||(Z?"Receipt processed successfully!":"Processed, but limited data extracted."))}else a("error"),m(u.error||"Failed to process receipt.")}catch(C){a("error"),m(C instanceof Error?C.message:"Failed to process receipt")}finally{c.current&&(c.current.value="")}};return e.jsxs("div",{className:"w-full",children:[e.jsx("h3",{className:"text-sm font-medium mb-2",children:"Verify OCR Settings"}),e.jsx("div",{className:"bg-gray-50 dark:bg-gray-800 p-4 rounded-md border border-dashed border-gray-300 dark:border-gray-600",children:e.jsxs("div",{className:"flex flex-col items-center justify-center space-y-3",children:[e.jsx("input",{ref:c,type:"file",accept:"image/jpeg,image/png,image/jpg,application/pdf",onChange:b,className:"hidden"}),i==="none"&&e.jsxs(e.Fragment,{children:[e.jsx(le,{className:"h-8 w-8 text-gray-500"}),e.jsx("p",{className:"text-sm text-center text-gray-500",children:"Upload receipt to verify settings."}),e.jsx(h,{type:"button",variant:"outline",onClick:g,disabled:t,className:"mt-2",children:"Upload for Verification"})]}),i==="loading"&&e.jsxs(e.Fragment,{children:[e.jsx(y,{className:"h-8 w-8 text-primary animate-spin"}),e.jsx("p",{className:"text-sm text-center text-gray-500",children:l})]}),i==="success"&&e.jsxs(e.Fragment,{children:[e.jsx(me,{className:"h-8 w-8 text-green-500"}),e.jsx("p",{className:"text-sm text-center text-green-500 font-medium",children:l}),Object.keys(x).length>0&&e.jsx("div",{className:"w-full mt-4 border rounded-md overflow-hidden",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-100 dark:bg-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left",children:"Field"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Value"})]})}),e.jsx("tbody",{className:"divide-y",children:Object.entries(x).map(([n,o])=>e.jsxs("tr",{className:"bg-white dark:bg-gray-800",children:[e.jsx("td",{className:"px-4 py-2 font-medium capitalize",children:n}),e.jsx("td",{className:"px-4 py-2",children:(o==null?void 0:o.toString())||"Not detected"})]},n))})]})}),e.jsx(h,{type:"button",variant:"outline",onClick:g,className:"mt-4",children:"Try Another"})]}),i==="error"&&e.jsxs(e.Fragment,{children:[e.jsx(de,{className:"h-8 w-8 text-red-500"}),e.jsx("p",{className:"text-sm text-center text-red-500",children:l}),e.jsx(h,{type:"button",variant:"outline",onClick:g,className:"mt-2",children:"Try Again"})]})]})}),e.jsxs("div",{className:"mt-6 w-full",children:[e.jsx("h3",{className:"text-sm font-medium mb-2",children:"OCR Methods Info"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 w-full text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"OpenAI Vision"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Requires API key with billing."})]}),e.jsxs("div",{className:"bg-primary/5 p-2 rounded-md",children:[e.jsx("p",{className:"font-medium",children:"Google Gemini (Recommended)"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Excellent receipt processing. Requires Gemini API key."})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Anthropic Claude"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Claude model with vision."})]})]})]})]})};function Ie(){const{toast:s}=M(),{ocrMethod:t,ocrApiKey:r,ocrTemplate:c,setOcrMethod:i,setOcrApiKey:a,setOcrTemplate:l}=B(),[m,x]=d.useState(!1),p=ee({resolver:re(he),defaultValues:{ocrMethod:t||"gemini",ocrApiKey:r||"",ocrTemplate:c||"travel"}});d.useEffect(()=>{p.reset({ocrMethod:t||"gemini",ocrApiKey:r||"",ocrTemplate:c||"travel"})},[t,r,c,p]);async function g(n){x(!0);try{await V("POST","/api/update-env",{ocrMethod:n.ocrMethod,apiKey:n.ocrApiKey,ocrTemplate:n.ocrTemplate}),i(n.ocrMethod),a(n.ocrApiKey||null),l(n.ocrTemplate),s({title:"Settings updated",description:"OCR settings saved."})}catch(o){s({title:"Update failed",description:o instanceof Error?o.message:"Unknown error",variant:"destructive"})}finally{x(!1)}}async function b(){const n=p.getValues();x(!0);try{const o=await V("POST","/api/test-ocr",{method:n.ocrMethod,apiKey:n.ocrApiKey});s({title:"OCR Test Result",description:o.success?"OCR configuration tested successfully!":`Test failed: ${o.message}`,variant:o.success?"default":"destructive"})}catch(o){s({title:"OCR Test Failed",description:o instanceof Error?o.message:"Unknown error",variant:"destructive"})}finally{x(!1)}}return e.jsxs("div",{className:"flex flex-col md:flex-row h-screen",children:[e.jsx(ae,{}),e.jsxs(oe,{className:"flex-1 overflow-y-auto p-4 md:p-6",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"Settings"}),e.jsxs(xe,{defaultValue:"appearance",className:"space-y-6",children:[e.jsxs(Y,{children:[e.jsx(P,{value:"appearance",children:"Appearance"}),e.jsx(P,{value:"ocr",children:"OCR Configuration"})]}),e.jsx(F,{value:"appearance",children:e.jsx(ue,{})}),e.jsx(F,{value:"ocr",children:e.jsxs(Q,{children:[e.jsxs(H,{children:[e.jsx(J,{children:"OCR Configuration"}),e.jsx(W,{children:"Configure OCR settings for receipt processing."})]}),e.jsx(X,{children:e.jsx(ge,{ocrForm:p,onOcrSubmit:g,testOcrSettings:b,isSubmitting:m})}),e.jsxs(ce,{className:"flex flex-col items-start border-t pt-6 space-y-6",children:[e.jsx(fe,{ocrForm:p,isSubmitting:m}),e.jsxs("div",{className:"w-full mt-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Process Pending OCR Tasks"}),e.jsx(pe,{})]})]})]})})]})]})]})}export{Ie as default};
